# .shrc
# cross platform .bashrc
export EDITOR=/usr/bin/kak
export PAGER="less -R"

DEFAULT_TMUX="base"
if [ -z "$TMUX" ]; then
	if tmux ls |& grep $DEFAULT_TMUX >/dev/null 2>&1; then
		tmux attach -t $DEFAULT_TMUX
	else
		tmux new-session -t $DEFAULT_TMUX
	fi
fi

# User specific aliases and functions
alias ll='ls -Gla'
alias l='ls -Gl'
alias dir='ls'
alias fzf='fzf --reverse'
alias k='kubectl'
alias d='docker'
alias gs='git status'
alias gp='git pull'
alias gpu='git push'
alias gc='git checkout'
alias tf='terraform'
alias c='code .'
alias p='podman'
alias what='echo $?'
alias config='git --git-dir=$HOME/.cfg/ --work-tree=$HOME'
alias protontricks-flat='flatpak run --command=protontricks com.valvesoftware.Steam'
alias bx='ibmcloud'
alias xclip='xclip -selection clipboard'
alias ipsort='sort -t . -k 3,3n -k 4,4n'

a() {
	awk "${@:2}" "{ print \$$1 }"
}

cl() {
	cd "$1" || exit
	ls -Gl
}

gd() {
	go doc "$1" | less
}

gocover() {
	FILE=${1:-coverage.out}
	go test -coverprofile "$FILE"
	go tool cover -html="$FILE"
}

if [ "$(uname -s)" == "Linux" ]; then
	alias open='xdg-open'
fi

gettex() {
	curl -k "https://gitlab.inahga.org/-/snippets/21/raw" >"$1"
}

if [ -e ~/.git-prompt ]; then
	source ~/.git-prompt
fi

alias kakoune='command kak'
kak() {
	GITREPO=$(git rev-parse --show-toplevel 2>/dev/null)
	SESSION=general
	if [ -n "$GITREPO" ]; then
		SESSION=$(echo "$GITREPO" | md5sum | head -c6)
	fi

	if command kak -l | grep -q "$SESSION"; then
		command kak -c "$SESSION" "$@"
	else
		command kak -s "$SESSION" "$@"
	fi
}

alacritty-x11() {
	WINIT_UNIX_BACKEND=x11 alacritty "$@"
}

NPM_PACKAGES="$HOME/.node_modules"
export PATH="$PATH:$NPM_PACKAGES/bin:$HOME/.cargo/bin"
export MANPATH="${MANPATH-$(manpath)}:$NPM_PACKAGES/share/man"

# alacritty pinebook pro fix
# https://github.com/alacritty/alacritty/issues/128#issuecomment-663927477
if [ "$(uname -m)" == "aarch64" ]; then
	export PAN_MESA_DEBUG=gl3
fi

if [ -e /opt/ibm ]; then
	export GPG_TTY="$(tty)"
	export SSH_AUTH_SOCK=$(gpgconf --list-dirs agent-ssh-socket)
	gpgconf --launch gpg-agent

	export GOPRIVATE=github.ibm.com

	ghfind() {
		if [ -z "$1" ]; then
			less ~/.ssh/config.d/ghe-softlayer
		else
			grep -A4 "$1" ~/.ssh/config.d/ghe-softlayer
		fi
	}

	alias xclip='xclip -selection clipboard'

	export IBMCLOUD_IAM_TOKEN=$(jq -r .IAMToken ~/.bluemix/config.json)
	export IBMCLOUD_IAM_REFRESH_TOKEN=$(jq -r .IAMRefreshToken ~/.bluemix/config.json)
	export DOCKER_HOST=unix:///run/user/1000/podman/podman.sock
fi
